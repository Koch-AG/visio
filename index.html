<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">

  <style type="text/css">
    body {
      margin: 0;
      padding: 9;
      background: #FFFFFF;

      text-align: center;
      font-family: Arial, Helvetica, sans-serif;
      font-weight: 300;
      letter-spacing: .15em;
    }

    #debugger {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
    }
  </style>

  <title>kochvisio</title>
</head>
<body>
  <div id="debugger"></div>
  <div id="container"></div>

  <script src='vendor/javascripts/decoder.js'></script>
  <script src='vendor/javascripts/yuvcanvas.js'></script>
  <script src='vendor/javascripts/player.js'></script>

  <script>
    var kochvisio = {
      container: document.getElementById('container'),
      debugger: document.getElementById('debugger'),
      playing: false,
      socket: null,

      initializePlayer(workerFile, webglMode) {
        if (!window.player) {
          window.player = new Player({
            workerFile: workerFile,
            useWorker: (workerFile) ? true : false,
            webgl: webglMode,
            size: {
              width: 640,
              height: 480
            }
          });

          document.getElementById('container').appendChild(window.player.canvas);
          window.debugger = new debug('container');
        }
      },

      startStream(streamLink, reconnectTimeout) {
        var separator = new Uint8Array([0, 0, 0, 1]);
        function appendSeparator(buffer) {
          var tmp = new Uint8Array(4+buffer.byteLength);
          tmp.set(separator, 0);
          tmp.set(new Uint8Array(buffer), 4);
          return tmp.buffer;
        }

        kochvisio.socket = new WebSocket(streamLink);
        kochvisio.socket.binaryType = 'arraybuffer'
        kochvisio.playing = true;

        kochvisio.socket.onopen = function (e) {
          console.log('kochvisio: websocket connected');

          kochvisio.socket.onmessage = function (msg) {
            window.player.decode(new Uint8Array(appendSeparator(msg.data)));
            if(window.debugger) window.debugger.nal(msg.data.byteLength);
          }
        }

        kochvisio.socket.onclose = function (e) {
          console.log('kochvisio: websocket disconnected');

          if (kochvisio.playing && reconnectTimeout > 0) {
            setTimeout(function() {
              console.log('kochvisio: reconnecting in ' + reconnectTimeout);
              kochvisio.startStream(streamLink, reconnectTimeout);
            }, reconnectTimeout)
          }

          kochvisio.playing = false;
        }
      },

      stopStream() {
        kochvisio.playing = false;
        kochvisio.socket.close();
      },

      startDebugger() {
        kochvisio.debugger.style.display = 'block';
      },

      stopDebugger() {
        kochvisio.debugger.style.direction = 'none';
      }
    }

    kochvisio.initializePlayer('./vendor/javascripts/decoder.js', 'auto');
    kochvisio.startStream('ws://127.0.0.1:3060/atlas/socket/test/consumer', 2000);

    // debugger stuff
    function avgFPS(length) {
      this.index = 0
      this.sum = 0
      this.length = length
      this.buffer = Array.apply(null, Array(length)).map(Number.prototype.valueOf,0);
      this.tick = function(tick) {
        this.sum -= this.buffer[this.index]
        this.sum += tick
        this.buffer[this.index] = tick
        if (++this.index == this.length) this.index = 0
        return Math.floor(this.sum/this.length)
      }
      this.avg = function() {
        return Math.floor(this.sum/this.length)
      }
      return this
    }

    function debug(playerId) {
      this.started = +new Date()
      this.fps = new avgFPS(50)
      this.last = +new Date()
      this.nals = 0
      this.frames = 0
      this.total = 0
      this.secondTotal = 0
      this.playerWidth = 0
      this.playerHeight = 0
      this.statsElement = document.createElement('div')
      document.getElementById(playerId).appendChild(this.statsElement)
      window.player.onPictureDecoded = function(buffer, width, height, infos) {
        window.debugger.frame(width, height)
      }
      this.nal = function(bytes) {
        this.nals++
        this.total += bytes
        this.secondTotal += bytes
      }
      this.frame = function(w, h) {
        this.playerWidth = w
        this.playerHeight = h
        this.frames++
        var now = +new Date(), delta = now - window.debugger.last
        this.fps.tick(delta)
        this.last = now
      }
      setInterval(function() {
        var mib = (window.debugger.total/1048576).toFixed(2)
        var date = new Date(null)
        date.setSeconds((+new Date()-window.debugger.started)/1000)
        var dur = date.toISOString().substr(11, 8)
        window.debugger.statsElement.innerHTML = window.debugger.playerWidth+'x'+window.debugger.playerHeight+', '+Math.floor(1/window.debugger.fps.avg()*1000)+' fps, '+(window.debugger.secondTotal/1024).toFixed(2)+' KiB/s, total '+mib+' MiB, '+window.debugger.nals+' NAL units, '+window.debugger.frames+' frames in '+dur
        window.debugger.secondTotal = 0
      }, 1000)
    }
  </script>
</body>
</html>
