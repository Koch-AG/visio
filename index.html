<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">

  <style type="text/css">
    body {
      margin: 0;
      padding: 9;
      background: #FFFFFF;
      font-family: Arial, Helvetica, sans-serif;
    }

    #debugger {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      color: #FF0000;
      font-size: 0.9em;
      background: #FFFFFF;
    }
  </style>

  <title>kochvisio</title>
</head>
<body>
  <div id="debugger"></div>
  <div id="container"></div>

  <script src='vendor/javascripts/decoder.js'></script>
  <script src='vendor/javascripts/yuvcanvas.js'></script>
  <script src='vendor/javascripts/player.js'></script>

  <script>
    var kochvisio = {
      container: document.getElementById('container'),
      debugger: document.getElementById('debugger'),
      reconnectTimeout: null,
      playing: false,
      socket: null,

      initializePlayer(workerFile, webglMode, withDebugger, width, height) {
        if (!window.player) {
          window.player = new Player({
            workerFile: workerFile,
            useWorker: (workerFile) ? true : false,
            webgl: webglMode,
            size: {
              width: width,
              height: height
            }
          });

          document.getElementById('container').appendChild(window.player.canvas);

          if (withDebugger) {
            document.getElementById('debugger').style.display = 'block';
            window.visioDebugger = new kochvisio.streamDebugger();
          }
        }
      },

      startStream(streamLink, reconnectTimeout) {
        var separator = new Uint8Array([0, 0, 0, 1]);
        function appendSeparator(buffer) {
          var tmp = new Uint8Array(4+buffer.byteLength);
          tmp.set(separator, 0);
          tmp.set(new Uint8Array(buffer), 4);
          return tmp.buffer;
        }

        kochvisio.socket = new WebSocket(streamLink);
        kochvisio.socket.binaryType = 'arraybuffer'
        kochvisio.playing = true;

        kochvisio.socket.onopen = function (e) {
          console.log('kochvisio: websocket connected');

          kochvisio.socket.onmessage = function (msg) {
            if (msg.data.replace == undefined) {
              window.player.decode(new Uint8Array(appendSeparator(msg.data)));
              if(window.visioDebugger) window.visioDebugger.nal(msg.data.byteLength);
            } else {
              if (msg.data == 'invalid.stream') {
                console.log('kochvisio: server returned invalid.stream');
                kochvisio.stopStream();
              }
            }
          }
        }

        kochvisio.socket.onclose = function (e) {
          console.log('kochvisio: websocket disconnected');

          if (kochvisio.playing && reconnectTimeout > 0) {
            kochvisio.reconnectTimeout = setTimeout(function() {
              console.log('kochvisio: reconnecting in ' + reconnectTimeout);
              kochvisio.startStream(streamLink, reconnectTimeout);
            }, reconnectTimeout)
          }

          kochvisio.playing = false;
        }
      },

      stopStream() {
        if (kochvisio.socket) kochvisio.socket.close();
        clearTimeout(kochvisio.reconnectTimeout);
        kochvisio.playing = false;
      },

      streamDebugger: function() {
        this.fps = new kochvisio.fpsCalculator(50);
        this.started = +new Date();
        this.last = +new Date();
        this.nals = 0;
        this.total = 0;
        this.frames = 0;
        this.secondTotal = 0;
        this.playerWidth = 0;
        this.playerHeight = 0;

        this.statsElement = document.getElementById('debugger');
        window.player.onPictureDecoded = function(buffer, width, height, infos) {
          window.visioDebugger.frame(width, height);
        }

        this.nal = function(bytes) {
          this.nals++;
          this.total += bytes;
          this.secondTotal += bytes;
        }

        this.frame = function(w, h) {
          this.playerWidth = w;
          this.playerHeight = h;
          this.frames++;
          var now = +new Date(), delta = now - window.visioDebugger.last;
          this.fps.tick(delta);
          this.last = now;
        }

        setInterval(function() {
          var mib = (window.visioDebugger.total/1048576).toFixed(2);
          var date = new Date(null);
          date.setSeconds((+new Date()-window.visioDebugger.started)/1000);
          var dur = date.toISOString().substr(11, 8);
          
          window.visioDebugger.statsElement.innerHTML =
            window.visioDebugger.playerWidth+'x'+window.visioDebugger.playerHeight+', '+
            Math.floor(1/window.visioDebugger.fps.avg()*1000)+' fps, '+
            (window.visioDebugger.secondTotal/1024).toFixed(2)+' KiB/s, total '+mib+' MiB, '+
            window.visioDebugger.nals+' NAL units, '+window.visioDebugger.frames+' frames in '+dur;
          
          window.visioDebugger.secondTotal = 0;
        }, 1000)
      },

      fpsCalculator: function(length) {
        this.length = length;
        this.index = 0;
        this.sum = 0;

        this.buffer = Array.apply(null, Array(length)).map(Number.prototype.valueOf,0);
        
        this.tick = function(tick) {
          this.sum -= this.buffer[this.index];
          this.sum += tick;
          this.buffer[this.index] = tick;
          if (++this.index == this.length) this.index = 0;
          return Math.floor(this.sum/this.length);
        }

        this.avg = function() {
          return Math.floor(this.sum/this.length);
        }

        return this;
      }
    }
  </script>
</body>
</html>
